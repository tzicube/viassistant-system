<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ViRecord</title>
    <link rel="stylesheet" href="virecord.css" />
  </head>

  <body>
    <!--
      ============================================================
      ViRecord UI (Translate + ESP32 Chat) - API FIRST
      - UI n√†y ch·ªâ l√† "khung": m·ªçi d·ªØ li·ªáu ƒë·∫øn t·ª´ API qua vi.js
      - 2 MODE:
          (A) TRANSLATE:   Audio -> STT -> Translate -> stt_text + translated_text (+ optional TTS)
          (B) ESP32 CHAT:  Audio -> STT -> AI Chat -> stt_text + assistant_text (+ optional TTS)
      - Hook IDs ƒë√£ chu·∫©n ho√° ƒë·ªÉ JS/ESP32 d·ªÖ t√≠ch h·ª£p
      ============================================================
    -->
    <div class="app" id="app">
      <!-- =========================
           TOP BAR
           ========================= -->
      <header class="topbar">
        <!-- [JS/UI] Click -> m·ªü drawer: add class .is-open v√†o #drawerWrap -->
        <button
          class="icon-btn"
          id="btnDrawer"
          aria-label="Open menu"
          aria-expanded="false"
        >
          <svg viewBox="0 0 24 24" aria-hidden="true">
            <path
              d="M4 6h10M18 6h2M4 12h2M8 12h12M4 18h14"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
            />
            <path
              d="M14 6a2 2 0 1 0-4 0a2 2 0 0 0 4 0ZM8 12a2 2 0 1 0-4 0a2 2 0 0 0 4 0ZM18 18a2 2 0 1 0-4 0a2 2 0 0 0 4 0Z"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
            />
          </svg>
        </button>

        <div class="brand">
          <!-- [API -> UI] app title / topic title -->
          <!-- JS set:
               - Translate mode:   #appTitle = data.title (client input)
               - Chat mode:        #appTitle = "ViAsistant" (preset)
          -->
          <div class="brand__title" id="appTitle">ViRecord</div>

          <!-- [API -> UI] status chip (idle / recording / processing / done / error) -->
          <!-- JS set: #statusChip.dataset.state = "idle|recording|processing|done|error" -->
          <!-- JS set: #statusText.textContent = "Idle / Recording / Processing..." -->
          <div
            class="status-chip"
            id="statusChip"
            data-state="idle"
            aria-live="polite"
          >
            <span class="status-dot" aria-hidden="true"></span>
            <span id="statusText">Idle</span>
          </div>
        </div>

        <!-- [API -> UI] avatar emoji / avatar image (optional) -->
        <button class="avatar-btn" id="btnProfile" aria-label="Profile">
          <span class="avatar" id="avatarEmoji" aria-hidden="true">üê•</span>
          <span class="avatar-hat" aria-hidden="true">üé©</span>
        </button>
      </header>

      <!-- =========================
           DRAWER (JS toggle .is-open on #drawerWrap)
           ========================= -->
      <div class="drawer-wrap" id="drawerWrap" aria-hidden="true">
        <!-- [JS/UI] Click overlay -> ƒë√≥ng drawer: remove .is-open kh·ªèi #drawerWrap -->
        <div class="drawer-overlay" id="drawerOverlay"></div>

        <aside class="drawer" role="dialog" aria-label="Side menu">
          <!-- =========================
               MODE SELECT
               ========================= -->
          <section class="drawer-section" aria-label="Mode">
            <div class="section-title">
              <span>Mode</span>
              <!-- [JS] hi·ªÉn th·ªã phi√™n b·∫£n engine -->
              <span class="hint" id="engineHint"
                >STT: Whisper v3 ‚Ä¢ TTS: XTTS</span
              >
            </div>

            <!--
              [JS/UI] Mode switch:
              - value="translate": App d·ªãch thu·∫≠t (1 endpoint STT+Translate)
              - value="chat": ESP32 Bot Chat (1 endpoint STT+Chat) preset conv_id=1
              JS:
              - set app mode
              - update labels, show/hide output block name (translated/assistant)
              - update request payload mapping
            -->
            <div class="mode-switch" role="radiogroup" aria-label="Select mode">
              <label class="mode-opt">
                <input
                  type="radio"
                  name="mode"
                  value="translate"
                  id="modeTranslate"
                  checked
                />
                <span class="mode-pill">
                  <span class="mode-ic" aria-hidden="true">üåê</span>
                  Translate
                </span>
              </label>
              <label class="mode-opt">
                <input type="radio" name="mode" value="chat" id="modeChat" />
                <span class="mode-pill">
                  <span class="mode-ic" aria-hidden="true">ü§ñ</span>
                  ESP32 Chat
                </span>
              </label>
            </div>

            <!--
              [API -> UI] Chat preset info (only for ESP32 Chat mode)
              JS:
              - show when mode=chat
              - ensure preset: conversation_id=1, title=ViAsistant
            -->
            <div class="preset-box" id="chatPresetBox" hidden>
              <div class="preset-row">
                <span class="preset-k">conversation_id</span>
                <span class="preset-v" id="conversationIdLabel">1</span>
              </div>
              <div class="preset-row">
                <span class="preset-k">title</span>
                <span class="preset-v" id="conversationTitleLabel"
                  >ViAsistant</span
                >
              </div>
            </div>
          </section>

          <!-- =========================
               LANGUAGE (Translate mode mainly; Chat mode can still show for future)
               ========================= -->
          <section class="drawer-section" aria-label="Language">
            <div class="section-title">
              <span>Language</span>
              <span class="hint">input_lang / output_lang</span>
            </div>

            <div class="lang-row">
              <!-- [API -> UI] Input flag -->
              <div class="flag" id="fromFlag" title="Input language flag">
                üè≥Ô∏è
              </div>

              <!-- [JS/UI] Click -> open dropdown select "from" -->
              <button class="select" id="fromLangBtn" type="button">
                <span class="select__label" id="fromLangLabel">Loading‚Ä¶</span>
                <span class="select__chev">‚ñæ</span>
              </button>
            </div>

            <div class="swap">
              <!-- [JS/UI] Swap language: from <-> to -->
              <button
                class="swap-btn"
                id="btnSwapLang"
                type="button"
                aria-label="Swap"
              >
                ‚Üï
              </button>
            </div>

            <div class="lang-row">
              <!-- [API -> UI] Output flag -->
              <div class="flag" id="toFlag" title="Output language flag">
                üè≥Ô∏è
              </div>

              <!-- [JS/UI] Click -> open dropdown select "to" -->
              <button class="select" id="toLangBtn" type="button">
                <span class="select__label" id="toLangLabel">Loading‚Ä¶</span>
                <span class="select__chev">‚ñæ</span>
              </button>
            </div>

            <!-- [API -> UI] Dropdown language list -->
            <!-- JS render data.language.list into #langDropdown by template #tplLangItem -->
            <div
              class="dropdown"
              id="langDropdown"
              aria-label="Language options"
            ></div>
          </section>

          <!-- =========================
               SETTINGS / INSTRUCTION (4th factor for AI)
               ========================= -->
          <section class="drawer-section" aria-label="Instruction">
            <div class="section-title">
              <span>Instruction</span>
              <span class="hint">setting (AI instruction)</span>
            </div>

            <!--
              Translate presets:
              - literal: s√°t nghƒ©a
              - natural: t·ª± nhi√™n
              - polite: l·ªãch s·ª±
              - short: ng·∫Øn g·ªçn
              JS:
              - when choose preset -> fill textarea (optional)
            -->
            <div class="form-row">
              <label class="label" for="settingPreset">Preset</label>
              <select class="field field--select" id="settingPreset">
                <option value="literal" selected>
                  Translate: S√°t nghƒ©a theo title + history
                </option>
                <option value="natural">Translate: T·ª± nhi√™n, d·ªÖ hi·ªÉu</option>
                <option value="polite">Translate: L·ªãch s·ª±, trang tr·ªçng</option>
                <option value="short">Translate: Ng·∫Øn g·ªçn</option>
                <option value="chat_short">Chat: Ng·∫Øn g·ªçn, th√¢n thi·ªán</option>
                <option value="chat_polite">Chat: Tr·ª£ l√Ω ·∫£o l·ªãch s·ª±</option>
              </select>
            </div>

            <!--
              [JS -> SERVER] setting_text: instruction t·ª± do c·ªßa user
              - Translate: "D·ªãch s√°t nghƒ©a theo title v√† l·ªãch s·ª≠ chat..."
              - Chat: "Tr·∫£ l·ªùi ng·∫Øn g·ªçn..."
            -->
            <div class="form-row">
              <label class="label" for="settingText">Custom setting</label>
              <textarea
                class="field field--textarea"
                id="settingText"
                rows="4"
                placeholder='VD: "D·ªãch s√°t nghƒ©a theo title v√† l·ªãch s·ª≠ chat" ho·∫∑c "Tr·∫£ l·ªùi ng·∫Øn g·ªçn, th√¢n thi·ªán, ƒë√∫ng tr·ªçng t√¢m"'
              ></textarea>
            </div>

            <!--
              [JS/UI] TTS toggle (Coqui XTTS-v2)
              - If ON: server tr·∫£ th√™m assistant_audio_url / translated_audio_url
              - If OFF: ch·ªâ text
            -->
            <div class="toggle-row">
              <label class="toggle">
                <input type="checkbox" id="ttsToggle" checked />
                <span class="toggle-ui" aria-hidden="true"></span>
                <span class="toggle-text">Enable TTS (XTTS)</span>
              </label>
            </div>
          </section>

          <!-- =========================
               TOPIC (history json - Translate) / Conversation (Chat)
               ========================= -->
          <section class="drawer-section" aria-label="Topic">
            <button class="topic-head" type="button" id="btnTopic">
              <span class="topic-head__left">
                <svg viewBox="0 0 24 24" aria-hidden="true">
                  <path
                    d="M3 6h7l2 2h9v10a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V6Z"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                    stroke-linejoin="round"
                  />
                </svg>
                <span id="topicTitle">Topic</span>
              </span>
              <span class="topic-head__chev">‚ñæ</span>
            </button>

            <!--
              [API -> UI] topic list
              - Translate mode: show topics (title list) for JSON history files
              - Chat mode: can hide topics or keep (optional)
            -->
            <div class="topic-list" id="topicList"></div>

            <!--
              [JS/UI] Quick actions (optional but useful for demo)
              - export JSON history
              - reset chat conversation_id=1
            -->
            <div class="drawer-actions">
              <button class="btn btn--ghost" id="btnExportJson" type="button">
                Export JSON
              </button>
              <button class="btn btn--danger" id="btnResetChat" type="button">
                Reset Chat (id=1)
              </button>
            </div>
          </section>
        </aside>
      </div>

      <!-- =========================
           MAIN CONTENT
           ========================= -->
      <main class="content">
        <section class="stack">
          <!-- INFO BAR: show current mode + endpoint hint -->
          <div class="infobar">
            <!-- [JS] update when mode changes -->
            <div class="infobar__left">
              <span class="badge" id="modeBadge" data-mode="translate"
                >TRANSLATE</span
              >
              <span class="infotext" id="endpointHint">
                Endpoint: <code>/api/translate_audio</code> (1 request)
              </span>
            </div>

            <!-- [JS/UI] processing step -->
            <!-- JS set: #stepText = "Normalize ‚Üí STT ‚Üí AI ‚Üí TTS" -->
            <div class="infobar__right">
              <span class="step" id="stepText">Ready</span>
            </div>
          </div>

          <!-- TOP SPLIT -->
          <div class="panel panel--split">
            <!-- LEFT (source / stt text) -->
            <article class="card card--cool" aria-label="STT output">
              <div class="card__head">
                <div class="card__icon">
                  <svg viewBox="0 0 24 24" aria-hidden="true">
                    <path
                      d="M11 4c-3.3 0-6 2.7-6 6v2c0 2 1 3 2 3h1l2 5h2l-1.2-5H14c2.8 0 5-2.2 5-5V9c0-2.8-2.2-5-5-5h-3Z"
                      fill="currentColor"
                      opacity="0.9"
                    />
                    <path
                      d="M20 9c1.3 1.3 1.3 4.7 0 6M22 7c2.2 2.2 2.2 7.8 0 10"
                      fill="none"
                      stroke="currentColor"
                      stroke-width="2"
                      stroke-linecap="round"
                    />
                  </svg>
                </div>

                <!-- Toolbar actions (STT) -->
                <div class="toolbar">
                  <!-- [JS/UI] Copy stt_text -->
                  <button
                    class="tool-btn"
                    id="btnCopySTT"
                    type="button"
                    title="Copy STT"
                  >
                    Copy
                  </button>

                  <!-- [JS/UI] Edit STT (optional feature) -->
                  <button
                    class="tool-btn"
                    id="btnEditSTT"
                    type="button"
                    title="Edit STT"
                  >
                    Edit
                  </button>
                </div>
              </div>

              <div class="watermark watermark--sun" aria-hidden="true"></div>

              <!-- [API -> UI] STT text -->
              <div class="card__text" id="sourceText">
                <div class="skeleton s1"></div>
                <div class="skeleton s2"></div>
                <div class="skeleton s3"></div>
              </div>

              <!-- [API -> UI] Pager/dots -->
              <div class="pager" id="sourcePager" aria-hidden="true"></div>
            </article>

            <!-- RIGHT (translated text OR assistant text) -->
            <article class="card card--warm" aria-label="AI output">
              <div class="card__head">
                <!-- Output title changes by mode -->
                <div class="card__label">
                  <!-- [JS] translate: "Translation" | chat: "Assistant" -->
                  <span id="outputLabel">Translation</span>
                </div>

                <div class="toolbar">
                  <!-- [JS/UI] Copy AI output -->
                  <button
                    class="tool-btn"
                    id="btnCopyAI"
                    type="button"
                    title="Copy output"
                  >
                    Copy
                  </button>

                  <!-- [JS/UI] Play TTS if server returns audio url -->
                  <!-- JS: if tts enabled and audio exists -> enable button -->
                  <button
                    class="tool-btn"
                    id="btnPlayTTS"
                    type="button"
                    title="Play TTS"
                    disabled
                  >
                    Play
                  </button>
                </div>
              </div>

              <!-- [API -> UI]
                   translate mode: #targetText = translated_text
                   chat mode:      #targetText = assistant_text
              -->
              <div class="card__text" id="targetText">
                <div class="skeleton s1"></div>
                <div class="skeleton s2"></div>
                <div class="skeleton s3"></div>
              </div>

              <!-- [JS] hidden audio player for TTS playback -->
              <!-- JS set: #ttsAudio.src = translated_audio_url or assistant_audio_url -->
              <audio id="ttsAudio" preload="auto"></audio>

              <div class="pager" id="targetPager" aria-hidden="true"></div>
            </article>
          </div>

          <div class="divider"></div>

          <!-- BOTTOM (history / detail view) -->
          <div class="panel panel--single">
            <article class="card card--warm card--large" aria-label="History">
              <div class="card__head">
                <div class="card__icon">
                  <svg viewBox="0 0 24 24" aria-hidden="true">
                    <path
                      d="M4 4h10v4H4V4Zm0 6h10v10H4V10Z"
                      fill="none"
                      stroke="currentColor"
                      stroke-width="2"
                    />
                    <path
                      d="M16 7h6M19 4v6M14 20l4-10 4 10"
                      fill="none"
                      stroke="currentColor"
                      stroke-width="2"
                      stroke-linecap="round"
                      stroke-linejoin="round"
                    />
                  </svg>
                </div>

                <div class="card__label">
                  <!-- [JS] Translate mode: "JSON History (no ID)" | Chat mode: "DB History (conversation_id=1)" -->
                  <span id="historyLabel">JSON History</span>
                </div>

                <div class="toolbar">
                  <!-- [JS/UI] refresh history -->
                  <button class="tool-btn" id="btnRefreshHistory" type="button">
                    Refresh
                  </button>
                  <!-- [JS/UI] export -->
                  <button class="tool-btn" id="btnExportHistory" type="button">
                    Export
                  </button>
                </div>
              </div>

              <div class="watermark watermark--star" aria-hidden="true"></div>

              <!-- [API -> UI] History / detail / full conversation -->
              <!-- JS set: #noteText.innerHTML = render(history list) -->
              <div class="card__text" id="noteText">
                <!-- empty state -->
                <div class="empty" id="historyEmpty" hidden>
                  No history yet. Record something to create messages.
                </div>
              </div>

              <div class="pager" id="notePager" aria-hidden="true"></div>
            </article>
          </div>
        </section>
      </main>

      <!-- =========================
           MIC BAR (Web/App record)
           - ESP32 kh√¥ng d√πng UI n√†y, nh∆∞ng Web/App d√πng ƒë·ªÉ test endpoint.
           ========================= -->
      <footer class="micbar">
        <!--
          [JS/UI] Click mic:
            - startRecording() / stopRecording()
            - toggle class .is-recording cho #btnMic
            - set status: recording/processing
            - build payload:
                - title:            from UI (topic/typed)
                - input_lang:       from UI
                - output_lang:      from UI
                - setting:          from #settingText or preset
                - history:          loaded from server JSON/DB
                - audio:            wav
        -->
        <button
          class="mic-btn"
          id="btnMic"
          aria-label="Record"
          aria-pressed="false"
        >
          <svg class="mic-ic" viewBox="0 0 24 24" aria-hidden="true">
            <path
              d="M12 14a3 3 0 0 0 3-3V6a3 3 0 0 0-6 0v5a3 3 0 0 0 3 3Z"
              fill="currentColor"
            />
            <path
              d="M19 11a7 7 0 0 1-14 0"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
            />
            <path
              d="M12 18v3"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
            />
          </svg>

          <!-- recording: solid circle -->
          <span class="mic-stop" aria-hidden="true"></span>

          <!-- processing spinner overlay -->
          <span class="mic-spinner" aria-hidden="true"></span>
        </button>
      </footer>

      <!-- =========================
           TOAST / ERROR
           ========================= -->
      <div
        class="toast-wrap"
        id="toastWrap"
        aria-live="assertive"
        aria-atomic="true"
      ></div>

      <!-- =========================
           TEMPLATES for JS render
           ========================= -->

      <!-- Language item template -->
      <template id="tplLangItem">
        <button class="dropdown-item" type="button" data-id="">
          <span class="flag flag--mini" data-flag>üè≥Ô∏è</span>
          <span class="dropdown-text" data-name>‚Äî</span>
        </button>
      </template>

      <!-- New topic button template -->
      <template id="tplTopicNew">
        <button
          class="topic-item topic-item--new"
          type="button"
          id="btnNewTopic"
        >
          + New topic
        </button>
      </template>

      <!-- Topic item template -->
      <template id="tplTopicItem">
        <button class="topic-item" type="button" data-id="">‚Äî</button>
      </template>

      <!-- Dot template -->
      <template id="tplDot">
        <span class="dot"></span>
      </template>

      <!-- History message template (optional) -->
      <template id="tplMsg">
        <div class="msg" data-role="">
          <div class="msg__meta">
            <span class="msg__role">user</span>
            <span class="msg__time">‚Äî</span>
          </div>
          <div class="msg__body">‚Äî</div>
        </div>
      </template>

      <!-- Toast template -->
      <template id="tplToast">
        <div class="toast" data-type="info">
          <div class="toast__title">Info</div>
          <div class="toast__msg">‚Äî</div>
        </div>
      </template>

      <!-- Main JS -->
      <script src="virecord.js"></script>
    </div>
  </body>
</html>
